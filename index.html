<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>App de Citas Emocionales</title>
  <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js"></script>
  <style>
    body {
      font-family: Arial, sans-serif;
      background: #f0f4f8;
      display: flex;
      flex-direction: column;
      align-items: center;
      padding: 20px;
    }
    form, #card, #chatBox {
      width: 100%;
      max-width: 300px;
      background: #fff;
      padding: 20px;
      border-radius: 10px;
      box-shadow: 0 4px 10px rgba(0,0,0,0.2);
      margin-top: 10px;
    }
    input, select, button {
      width: 100%;
      padding: 10px;
      margin-top: 10px;
      font-size: 1em;
      border-radius: 5px;
      border: 1px solid #ccc;
    }
    #profile-img {
      width: 100%;
      height: 200px;
      object-fit: cover;
      border-radius: 10px;
    }
    #actions {
      display: flex;
      justify-content: space-between;
      margin-top: 10px;
    }
    #matchMessage {
      margin-top: 10px;
      color: green;
    }
    #chatBox {
      display: none;
    }
    #chatMessages {
      height: 150px;
      overflow-y: auto;
      background: #eef;
      padding: 10px;
      border-radius: 5px;
      margin-top: 10px;
    }
  </style>
</head>
<body>
  <h1>App de Citas Emocionales</h1>

  <form id="registerForm">
    <input type="text" id="nameInput" placeholder="Tu nombre" required />
    <input type="url" id="imageInput" placeholder="URL de tu foto (opcional)" />
    <select id="estadoEmocional" required>
      <option value="">¿Cómo te sientes hoy?</option>
      <option value="ansiedad">Ansiedad</option>
      <option value="depresión">Depresión</option>
      <option value="bipolaridad">Bipolaridad</option>
      <option value="autismo">Autismo</option>
      <option value="duelo">En duelo</option>
    </select>
    <button type="submit">Registrar</button>
  </form>

  <div id="card" style="display:none">
    <img id="profile-img" src="" alt="Perfil" />
    <div id="name"></div>
    <div id="estado"></div>
    <div id="ubicacion"></div>
    <div id="actions">
      <button id="dislikeBtn">No Me Gusta</button>
      <button id="likeBtn">Me Gusta</button>
    </div>
    <div id="matchMessage"></div>
  </div>

  <div id="chatBox">
    <h3>Chat con tu Match</h3>
    <div id="chatMessages"></div>
    <input type="text" id="chatInput" placeholder="Escribe tu mensaje" />
    <button onclick="sendMessage()">Enviar</button>
  </div>

  <script>
    const firebaseConfig = {
      // Tu configuración real aquí, respetada
    };
    firebase.initializeApp(firebaseConfig);
    const db = firebase.firestore();

    const registerForm = document.getElementById('registerForm');
    const card = document.getElementById('card');
    const nameDiv = document.getElementById('name');
    const estadoDiv = document.getElementById('estado');
    const profileImg = document.getElementById('profile-img');
    const ubicacionDiv = document.getElementById('ubicacion');
    const matchMessage = document.getElementById('matchMessage');
    const likeBtn = document.getElementById('likeBtn');
    const dislikeBtn = document.getElementById('dislikeBtn');
    const chatBox = document.getElementById('chatBox');
    const chatMessages = document.getElementById('chatMessages');
    const chatInput = document.getElementById('chatInput');

    let profiles = [];
    let currentIndex = 0;
    let currentUserId = null;
    let currentMatchId = null;

    registerForm.addEventListener('submit', async (e) => {
      e.preventDefault();
      const name = document.getElementById('nameInput').value;
      const image = document.getElementById('imageInput').value || 'https://randomuser.me/api/portraits/lego/1.jpg';
      const estado = document.getElementById('estadoEmocional').value;

      // Intentar obtener ubicación automática
      let ubicacion = 'Monterrey';
      if (navigator.geolocation) {
        navigator.geolocation.getCurrentPosition(
          pos => {},
          err => {},
          { timeout: 5000 }
        );
      }

      const userRef = await db.collection('users').add({
        name, image, estado, ubicacion, likedBy: []
      });

      currentUserId = userRef.id;
      alert('¡Registrado! Ahora puedes ver a otros.');
      registerForm.style.display = 'none';
      loadProfiles();
    });

    async function loadProfiles() {
      const snapshot = await db.collection('users').get();
      profiles = snapshot.docs
        .filter(doc => doc.id !== currentUserId)
        .map(doc => ({ id: doc.id, ...doc.data() }));
      currentIndex = 0;
      showProfile(currentIndex);
    }

    function showProfile(index) {
      if (index >= profiles.length) {
        card.style.display = 'none';
        alert('No hay más perfiles por hoy.');
        return;
      }
      const profile = profiles[index];
      profileImg.src = profile.image;
      nameDiv.textContent = profile.name;
      estadoDiv.textContent = `Estado: ${profile.estado}`;
      ubicacionDiv.textContent = `Ubicación: ${profile.ubicacion}`;
      card.style.display = 'block';
      matchMessage.textContent = '';
    }

    likeBtn.addEventListener('click', async () => {
      const profile = profiles[currentIndex];
      const profileRef = db.collection('users').doc(profile.id);
      await profileRef.update({
        likedBy: firebase.firestore.FieldValue.arrayUnion(currentUserId)
      });
      const matchSnapshot = await profileRef.get();
      const likedBy = matchSnapshot.data().likedBy || [];
      if (likedBy.includes(currentUserId)) {
        matchMessage.textContent = `¡Has hecho match con ${profile.name}!`;
        currentMatchId = profile.id;
        chatBox.style.display = 'block';
        loadMessages();
      }
      currentIndex++;
      showProfile(currentIndex);
    });

    dislikeBtn.addEventListener('click', () => {
      currentIndex++;
      showProfile(currentIndex);
    });

    async function loadMessages() {
      db.collection('chats')
        .doc(currentUserId + '_' + currentMatchId)
        .collection('messages')
        .orderBy('timestamp')
        .onSnapshot(snapshot => {
          chatMessages.innerHTML = '';
          snapshot.forEach(doc => {
            const msg = doc.data();
            const div = document.createElement('div');
            div.textContent = `${msg.sender === currentUserId ? 'Tú' : 'Ell@'}: ${msg.text}`;
            chatMessages.appendChild(div);
          });
        });
    }

    async function sendMessage() {
      const text = chatInput.value;
      if (!text.trim()) return;
      const chatId = currentUserId + '_' + currentMatchId;
      await db.collection('chats')
        .doc(chatId)
        .collection('messages')
        .add({
          sender: currentUserId,
          text,
          timestamp: firebase.firestore.FieldValue.serverTimestamp()
        });
      chatInput.value = '';
    }
  </script>
</body>
  </html>
